---
name: "qt-linux"
suites:
- "precise"
architectures:
- "i386"
- "amd64"
packages:
- "zip"
- "unzip"
- "faketime"
- "unzip"
- "libdbus-1-dev"
- "libx11-dev"
- "libxcb1-dev"
- "libfontconfig1-dev"
reference_datetime: "2011-01-30 00:00:00"
remotes: []
files:
- "qt-everywhere-opensource-src-5.2.1.tar.gz"
- "bitcoin-deps-linux32-gitian-r6.zip"
- "bitcoin-deps-linux64-gitian-r6.zip"
script: |

  echo "84e924181d4ad6db00239d87250cc89868484a14841f77fb85ab1f1dbdcd7da1  qt-everywhere-opensource-src-5.2.1.tar.gz" | sha256sum -c

  export FAKETIME=$REFERENCE_DATETIME
  export TZ=UTC
  PREFIX="$HOME/install"

  export TAR_OPTIONS="-m --mtime="$REFERENCE_DATE\\\ $REFERENCE_TIME""
  export GZIP="-9n"

  REAL_AR=`which ar`
  REAL_DATE=`which date`
  REAL_RANLIB=`which ranlib`

  echo '#!/bin/bash' > $HOME/ar
  echo 'export LD_PRELOAD=/usr/lib/faketime/libfaketime.so.1' >> $HOME/ar
  echo "export FAKETIME=\"${REFERENCE_DATETIME}\"" >> $HOME/ar
  echo "$REAL_AR \$@" >> $HOME/ar

  echo '#!/bin/bash' > $HOME/ranlib
  echo 'export LD_PRELOAD=/usr/lib/faketime/libfaketime.so.1' >> $HOME/ranlib
  echo "export FAKETIME=\"${REFERENCE_DATETIME}\"" >> $HOME/ranlib
  echo "$REAL_RANLIB \$@" >> $HOME/ranlib

  echo '#!/bin/bash' > $HOME/date
  echo "$REAL_DATE -d \"${REFERENCE_DATETIME}\" \"\$@\"" >> $HOME/date

  chmod +x $HOME/ar $HOME/ranlib $HOME/date

  export PATH=$HOME:$PATH

  pushd $PREFIX
  unzip ~/build/bitcoin-deps-linux${GBUILD_BITS}-gitian-r6.zip
  popd

  tar xzf qt-everywhere-opensource-src-5.2.1.tar.gz
  pushd qt-everywhere-opensource-src-5.2.1


  OPENSSL_LIBS="-L$PREFIX/lib -lssl -lcrypto" ./configure -release -opensource -no-audio-backend -no-sql-sqlite -no-sql-tds -no-cups -no-iconv -no-gif -no-sql-sqlite -no-nis -no-cups -no-iconv -no-pch -no-sm -nomake examples -no-feature-style-plastique -no-qml-debug -no-pch -no-nis -no-feature-style-cde -no-feature-style-s60 -no-feature-style-motif -no-feature-style-windowsmobile -no-feature-style-windowsce -no-feature-style-cleanlooks -no-sql-db2 -no-sql-ibase -no-sql-oci -no-sql-tds -no-sql-mysql -no-sql-odbc -no-sql-psql -no-sql-sqlite -no-sql-sqlite2 -skip qtsvg -skip qtwebkit -skip qtwebkit-examples -skip qtserialport -skip qtdeclarative -skip qtmultimedia -skip qtimageformats -skip qtlocation -skip qtsensors -skip qtquick1 -skip qtxmlpatterns -skip qtquickcontrols -skip qtactiveqt -skip qtconnectivity -skip qtwinextras -skip qtscript -qt-xcb  -no-eglfs -no-linuxfb -no-icu -no-glib -qt-xkbcommon -no-feature-audio-backend -openssl-linked -no-c++11 -qt-freetype -v -static -prefix $PREFIX -confirm-license -L$PREFIX/lib -I$PREFIX/include

  QT_RCC_TEST=1 make $MAKEOPTS

  make -C qtbase install
  make -C qttranslations install
  make -C qttools/src/linguist install


  # libxcb-static is not installed due to a qt bug so it needs to be manually
  # installed: https://bugreports.qt-project.org/browse/QTBUG-32519
  # This has been fixed in 5.3.
  install qtbase/src/plugins/platforms/xcb/xcb-static/libxcb-static.a $PREFIX/lib/

  rm -f ${PREFIX}/lib/*.la
  find ${PREFIX}/lib -name "*.prl" -delete

  popd

  cd $PREFIX/../
  find install | sort | tar --no-recursion -czf $OUTDIR/qt-linux${GBUILD_BITS}-5.2.1-gitian-r1.tar.gz -T -
